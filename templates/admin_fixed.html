{% extends "base.html" %}

{% block title %}Administration - Dev Learning Hub{% endblock %}

{% block head %}
<style>
/* Am√©liorations visuelles pour la page admin */
.admin-header {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a4a3a 50%, #0a0a0a 100%);
    border: 1px solid #00ff41;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.admin-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.1), transparent);
    animation: scan 3s infinite;
}

@keyframes scan {
    0% { left: -100%; }
    100% { left: 100%; }
}

.title-icon.pulsing {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.matrix-code {
    font-family: 'JetBrains Mono', monospace;
    color: #00ff41;
    font-size: 0.8em;
    opacity: 0.7;
    letter-spacing: 2px;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    padding: 5px 15px;
    background: rgba(0, 255, 65, 0.1);
    border: 1px solid #00ff41;
    border-radius: 20px;
    font-size: 0.8em;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #00ff41;
    border-radius: 50%;
    animation: blink 1.5s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.highlight-card { border-color: #00ff41; box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); }
.success-card { border-color: #4CAF50; box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
.info-card { border-color: #2196F3; box-shadow: 0 0 20px rgba(33, 150, 243, 0.3); }
.warning-card { border-color: #FF9800; box-shadow: 0 0 20px rgba(255, 152, 0, 0.3); }

.stat-trend {
    font-size: 0.8em;
    color: #00ff41;
    margin-top: 5px;
    opacity: 0.8;
}

.log-item {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
    padding-left: 15px;
}

.success-log { border-left-color: #4CAF50; }
.info-log { border-left-color: #2196F3; }
.security-log { border-left-color: #FF9800; }
.warning-log { border-left-color: #FFC107; }
.matrix-log { border-left-color: #00ff41; }

.log-status {
    margin-left: auto;
    padding: 2px 8px;
    background: rgba(0, 255, 65, 0.1);
    border: 1px solid #00ff41;
    border-radius: 10px;
    font-size: 0.7em;
    letter-spacing: 1px;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 255, 65, 0.2);
}

.btn-icon-small:hover {
    background: rgba(0, 255, 65, 0.2);
    transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- En-t√™te admin am√©lior√© -->
    <div class="admin-header">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1 style="color: #00ff41; margin: 0; display: flex; align-items: center; gap: 15px;">
                    <span class="title-icon pulsing">‚ö°</span>
                    ADMINISTRATION MATRIX
                    <span class="matrix-code">[ROOT_ACCESS]</span>
                </h1>
                <p style="margin: 10px 0 0 0; color: #888;">Contr√¥le total du syst√®me Dev Learning Hub</p>
            </div>
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>SYST√àME ACTIF</span>
            </div>
        </div>
    </div>

    <!-- Statistiques am√©lior√©es -->
    <div class="stats-grid">
        <div class="stat-card highlight-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total_users or 0 }}</div>
                <div class="stat-label">Utilisateurs totaux</div>
                <div class="stat-trend">üìä Base active</div>
            </div>
        </div>
        
        <div class="stat-card success-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total_quizzes or 0 }}</div>
                <div class="stat-label">Quiz disponibles</div>
                <div class="stat-trend">‚ú® Contenu riche</div>
            </div>
        </div>
        
        <div class="stat-card info-card">
            <div class="stat-icon">üîë</div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.admin_users or 0 }}</div>
                <div class="stat-label">Administrateurs</div>
                <div class="stat-trend">üõ°Ô∏è Acc√®s privil√©gi√©</div>
            </div>
        </div>
        
        <div class="stat-card warning-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-content">
                <div class="stat-number">5</div>
                <div class="stat-label">Connexions r√©centes</div>
                <div class="stat-trend">üìà +2 aujourd'hui</div>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="quick-actions">
        <h2>Actions rapides</h2>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="location.href='/quiz/new'">
                ‚ûï Nouveau Quiz
            </button>
            <button class="btn btn-secondary" onclick="exportData()">
                üì• Exporter Donn√©es
            </button>
            <button class="btn btn-secondary" onclick="systemCheck()">
                üîç V√©rifier Syst√®me
            </button>
        </div>
    </div>

    <!-- Journal d'activit√© am√©lior√© -->
    <div class="card">
        <h2>Journal d'activit√© r√©cente</h2>
        <div class="activity-logs">
            <div class="log-item success-log">
                <div>
                    <strong>Connexion utilisateur</strong><br>
                    <small>{{ now.strftime('%Y-%m-%d %H:%M') }} - Utilisateur 'admin' connect√©</small>
                </div>
                <span class="log-status">SUCCESS</span>
            </div>
            <div class="log-item info-log">
                <div>
                    <strong>Cr√©ation de quiz</strong><br>
                    <small>{{ now.strftime('%Y-%m-%d %H:%M') }} - Nouveau quiz Python ajout√©</small>
                </div>
                <span class="log-status">INFO</span>
            </div>
            <div class="log-item matrix-log">
                <div>
                    <strong>Commande console</strong><br>
                    <small>{{ now.strftime('%Y-%m-%d %H:%M') }} - Ex√©cution: matrix --status</small>
                </div>
                <span class="log-status">MATRIX</span>
            </div>
            <div class="log-item security-log">
                <div>
                    <strong>Tentative d'acc√®s</strong><br>
                    <small>{{ now.strftime('%Y-%m-%d %H:%M') }} - Acc√®s admin refus√© pour 'guest'</small>
                </div>
                <span class="log-status">SECURITY</span>
            </div>
        </div>
    </div>

    <!-- Gestion des utilisateurs -->
    <div class="card">
        <h2>Gestion des utilisateurs</h2>
        {% if users %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom d'utilisateur</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Inscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.is_admin %}
                                <span class="badge admin-badge">ADMIN</span>
                            {% endif %}
                        </td>
                        <td>{{ user.email or 'Non renseign√©' }}</td>
                        <td>
                            {% if user.is_admin %}
                                <span class="status-badge admin">Administrateur</span>
                            {% else %}
                                <span class="status-badge user">Utilisateur</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'Inconnue' }}</td>
                        <td class="action-buttons">
                            {% if user.username != 'admin' %}
                                <div class="btn-group">
                                    <button class="btn-icon-small" onclick="toggleAdmin({{ user.id }})" title="Toggle Admin">
                                        {% if user.is_admin %}üîΩ{% else %}‚¨ÜÔ∏è{% endif %}
                                    </button>
                                    <button class="btn-icon-small edit-btn" onclick="editUser({{ user.id }})" title="Modifier">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn-icon-small delete-btn" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" title="Supprimer">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            {% else %}
                                <span class="text-muted">Admin principal</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>Aucun utilisateur trouv√©.</p>
        {% endif %}
    </div>

    <!-- Console hacker pour admin -->
    <div class="card">
        <h2>Console Administrateur</h2>
        <div class="terminal-container">
            <div class="terminal-header">
                <span class="terminal-title">MATRIX ADMIN CONSOLE v3.0</span>
                <div class="terminal-controls">
                    <span class="terminal-btn close"></span>
                    <span class="terminal-btn minimize"></span>
                    <span class="terminal-btn maximize"></span>
                </div>
            </div>
            <div class="terminal-content">
                <div id="terminal-output">
                    <div class="terminal-line">
                        <span class="prompt">admin@matrix:~$</span> 
                        <span class="command">system status</span>
                    </div>
                    <div class="terminal-line output">‚úÖ Syst√®me op√©rationnel</div>
                    <div class="terminal-line output">üîê S√©curit√© active</div>
                    <div class="terminal-line output">üìä Monitoring en cours</div>
                </div>
                <div class="terminal-input-line">
                    <span class="prompt">admin@matrix:~$</span>
                    <input type="text" id="terminal-input" placeholder="Tapez votre commande..." autocomplete="off">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fonctions de gestion des utilisateurs
async function toggleAdmin(userId) {
    if (confirm('√ätes-vous s√ªr de vouloir modifier les privil√®ges administrateur ?')) {
        try {
            const response = await fetch(`/admin/users/${userId}/toggle-admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la modification');
            }
        } catch (error) {
            alert('Erreur r√©seau');
        }
    }
}

async function deleteUser(userId, username) {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?`)) {
        try {
            const response = await fetch(`/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                document.getElementById(`user-${userId}`).remove();
                alert('Utilisateur supprim√© avec succ√®s');
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            alert('Erreur r√©seau');
        }
    }
}

function editUser(userId) {
    // TODO: Impl√©menter la modification d'utilisateur
    alert('Fonctionnalit√© de modification √† impl√©menter');
}

function exportData() {
    alert('Export des donn√©es en cours...');
    // TODO: Impl√©menter l'export
}

function systemCheck() {
    alert('V√©rification syst√®me lanc√©e...');
    // TODO: Impl√©menter la v√©rification
}

// Console terminal pour admin
document.addEventListener('DOMContentLoaded', function() {
    const terminalInput = document.getElementById('terminal-input');
    const terminalOutput = document.getElementById('terminal-output');

    if (terminalInput) {
        terminalInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processAdminCommand(this.value);
                this.value = '';
            }
        });
    }

    function processAdminCommand(command) {
        // Ajouter la commande √† l'historique
        addTerminalLine(`admin@matrix:~$ ${command}`, 'command');
        
        // Traiter la commande
        switch(command.toLowerCase().trim()) {
            case 'help':
                addTerminalLine('Commandes disponibles:', 'output');
                addTerminalLine('- users: Liste des utilisateurs', 'output');
                addTerminalLine('- stats: Statistiques syst√®me', 'output');
                addTerminalLine('- logs: Logs r√©cents', 'output');
                addTerminalLine('- clear: Nettoyer la console', 'output');
                break;
            case 'users':
                addTerminalLine(`üë• ${document.querySelectorAll('tbody tr').length} utilisateurs actifs`, 'output');
                break;
            case 'stats':
                addTerminalLine('üìä Statistiques syst√®me:', 'output');
                addTerminalLine(`- Utilisateurs: ${document.querySelector('.highlight-card .stat-number').textContent}`, 'output');
                addTerminalLine(`- Quiz: ${document.querySelector('.success-card .stat-number').textContent}`, 'output');
                addTerminalLine(`- Admins: ${document.querySelector('.info-card .stat-number').textContent}`, 'output');
                break;
            case 'clear':
                terminalOutput.innerHTML = '';
                break;
            case 'matrix':
                addTerminalLine('üî¥üíä Bienvenue dans la Matrice...', 'matrix');
                break;
            default:
                addTerminalLine(`Commande inconnue: ${command}`, 'error');
                addTerminalLine('Tapez "help" pour voir les commandes disponibles', 'output');
        }
    }

    function addTerminalLine(text, type = 'output') {
        const line = document.createElement('div');
        line.className = `terminal-line ${type}`;
        line.textContent = text;
        terminalOutput.appendChild(line);
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
    }
});
</script>
{% endblock %}
