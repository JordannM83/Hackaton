{% extends "base.html" %}

{% block title %}HLH Tutor - Code Executor{% endblock %}

{% block extra_css %}
<style>
    .tutor-container {
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #00ff41;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
        backdrop-filter: blur(10px);
    }
    
    .tutor-header {
        text-align: center;
        color: #00ff41;
        margin-bottom: 2rem;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    
    .tutor-header h1 {
        font-family: 'Orbitron', monospace;
        font-weight: 900;
        color: #00ff41;
        text-shadow: 0 0 15px rgba(0, 255, 65, 0.6);
        margin-bottom: 0.5rem;
    }
    
    .tutor-header p {
        color: rgba(0, 255, 65, 0.8);
        font-family: 'Source Code Pro', monospace;
    }
    
    .toolbar {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(0, 20, 0, 0.8);
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 8px;
        flex-wrap: wrap;
        box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
    }
    
    .language-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .language-selector label {
        color: #00ff41;
        font-family: 'Source Code Pro', monospace;
        font-weight: 600;
        text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
    }
    
    .language-selector select {
        padding: 0.5rem;
        border: 2px solid #00ff41;
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff41;
        min-width: 150px;
        font-family: 'Source Code Pro', monospace;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    
    .language-selector select:focus {
        outline: none;
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
    }
    
    .run-btn, .clear-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Source Code Pro', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .run-btn {
        background: rgba(0, 255, 65, 0.1);
        border-color: #00ff41;
        color: #00ff41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    
    .clear-btn {
        background: rgba(255, 100, 100, 0.1);
        border-color: #ff6464;
        color: #ff6464;
        box-shadow: 0 0 10px rgba(255, 100, 100, 0.3);
    }
    
    .run-btn:hover {
        background: rgba(0, 255, 65, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
    }
    
    .clear-btn:hover {
        background: rgba(255, 100, 100, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 0 20px rgba(255, 100, 100, 0.5);
    }
    
    .run-btn:disabled {
        background: rgba(100, 100, 100, 0.2);
        border-color: #666;
        color: #666;
        transform: none;
        cursor: not-allowed;
        box-shadow: none;
    }
    
    .code-area {
        margin-bottom: 1rem;
    }
    
    .code-input {
        width: 100%;
        min-height: 300px;
        padding: 1rem;
        border: 2px solid #00ff41;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 14px;
        resize: vertical;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff41;
        box-sizing: border-box;
        box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
    }
    
    .code-input:focus {
        outline: none;
        box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.2), 0 0 15px rgba(0, 255, 65, 0.4);
    }
    
    .code-input::placeholder {
        color: rgba(0, 255, 65, 0.5);
    }
    
    .error-message {
        background: rgba(255, 100, 100, 0.2);
        color: #ff6464;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border: 1px solid #ff6464;
        border-left: 4px solid #ff6464;
        display: none;
        font-family: 'Source Code Pro', monospace;
        box-shadow: 0 0 10px rgba(255, 100, 100, 0.3);
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #00ff41;
        font-size: 1.1rem;
        font-family: 'Source Code Pro', monospace;
        text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    
    .trace-step {
        background: rgba(0, 20, 0, 0.6);
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 8px;
        margin: 1rem 0;
        padding: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
    }
    
    .trace-step:hover {
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        border-color: rgba(0, 255, 65, 0.5);
    }
    
    .trace-step h4 {
        color: #00ff41;
        font-family: 'Source Code Pro', monospace;
        text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        margin-bottom: 0.5rem;
    }
    
    .output-pre {
        background: rgba(0, 0, 0, 0.9);
        color: #00ff41;
        padding: 1rem;
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 6px;
        overflow-x: auto;
        margin: 0.5rem 0;
        white-space: pre-wrap;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.1);
    }
    
    .success-output {
        background: rgba(0, 50, 0, 0.8) !important;
        color: #00ff41 !important;
        border-color: #00ff41 !important;
    }
    
    .error-output {
        background: rgba(50, 0, 0, 0.8) !important;
        color: #ff6464 !important;
        border-color: #ff6464 !important;
    }
    
    .examples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .example-card {
        background: rgba(0, 20, 0, 0.6);
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
    }
    
    .example-card:hover {
        background: rgba(0, 30, 0, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        border-color: rgba(0, 255, 65, 0.5);
    }
    
    .example-title {
        font-weight: 600;
        color: #00ff41;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Source Code Pro', monospace;
        text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
    }
    
    .example-desc {
        color: rgba(0, 255, 65, 0.7);
        font-size: 0.9rem;
        font-family: 'Source Code Pro', monospace;
    }

    @media (max-width: 768px) {
        .toolbar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .language-selector {
            justify-content: center;
        }
        
        .run-btn, .clear-btn {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="tutor-container">
        <div class="tutor-header">
            <h1>üöÄ HLH Tutor - Ex√©cuteur de Code Multi-Langage</h1>
            <p style="color: #4a5568; margin-bottom: 0;">
                Ex√©cutez du code Python, JavaScript ou C avec visualisation des r√©sultats en temps r√©el
                <small style="opacity: 0.7;">v2.2 - Multi-langage complet</small>
            </p>
        </div>
        
        <div id="code-executor-container">
            <div class="toolbar">
                <div class="language-selector">
                    <label for="language-select" style="font-weight: 600;">üîß Langage:</label>
                    <select id="language-select">
                        <option value="python">üêç Python</option>
                        <option value="javascript">üìú JavaScript</option>
                        <option value="c">‚öôÔ∏è C</option>
                    </select>
                </div>
                <button id="run-button" class="run-btn">
                    <span>‚ñ∂Ô∏è</span> Ex√©cuter
                </button>
                <button id="clear-button" class="clear-btn">
                    <span>üóëÔ∏è</span> Effacer
                </button>
            </div>
            
            <div class="code-area">
                <textarea id="code-input" class="code-input" placeholder="Entrez votre code ici..."></textarea>
            </div>
            
            <div id="error-output" class="error-message"></div>
            <div id="trace-output" class="trace-visualization"></div>
        </div>
        
        <div class="examples">
            <div class="example-card" onclick="loadPythonExample()">
                <div class="example-title">
                    <span>üêç</span> Python - Variables et fonctions
                </div>
                <div class="example-desc">Variables, boucles, listes et r√©cursion</div>
            </div>
            
            <div class="example-card" onclick="loadJavaScriptExample()">
                <div class="example-title">
                    <span>üìú</span> JavaScript - Arrays et fonctions
                </div>
                <div class="example-desc">Variables, boucles, arrays et r√©cursion</div>
            </div>
            
            <div class="example-card" onclick="loadCExample()">
                <div class="example-title">
                    <span>‚öôÔ∏è</span> C - Structures de contr√¥le
                </div>
                <div class="example-desc">Variables, boucles, tableaux et pointeurs</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class HLHTutor {
    constructor() {
        this.currentLanguage = 'python';
        this.initializeUI();
    }
    
    initializeUI() {
        this.attachEvents();
        this.updatePlaceholder();
    }
    
    attachEvents() {
        const runButton = document.getElementById('run-button');
        const clearButton = document.getElementById('clear-button');
        const languageSelect = document.getElementById('language-select');
        
        runButton.addEventListener('click', () => this.runCode());
        clearButton.addEventListener('click', () => this.clearCode());
        languageSelect.addEventListener('change', (e) => {
            this.currentLanguage = e.target.value;
            this.updatePlaceholder();
        });
    }
    
    updatePlaceholder() {
        const codeInput = document.getElementById('code-input');
        const placeholders = {
            python: `# Code Python
x = 5
y = 10
result = x + y
print(f"La somme de {x} et {y} est {result}")

# Boucle simple
for i in range(3):
    print(f"Iteration {i}")`,
            javascript: `// Code JavaScript
let x = 5;
let y = 10;
let result = x + y;
console.log(\`La somme de \${x} et \${y} est \${result}\`);

// Boucle simple
for(let i = 0; i < 3; i++) {
    console.log(\`Iteration \${i}\`);
}`,
            c: `// Code C
#include <stdio.h>

int main() {
    int x = 5;
    int y = 10;
    int result = x + y;
    printf("La somme de %d et %d est %d\\n", x, y, result);
    
    // Boucle simple
    for(int i = 0; i < 3; i++) {
        printf("Iteration %d\\n", i);
    }
    
    return 0;
}`
        };
        codeInput.placeholder = placeholders[this.currentLanguage];
        if (!codeInput.value.trim()) {
            codeInput.value = placeholders[this.currentLanguage];
        }
    }
    
    clearCode() {
        document.getElementById('code-input').value = '';
        document.getElementById('trace-output').innerHTML = '';
        document.getElementById('error-output').style.display = 'none';
    }
    
    async runCode() {
        const codeInput = document.getElementById('code-input');
        const runButton = document.getElementById('run-button');
        const outputDiv = document.getElementById('trace-output');
        const errorDiv = document.getElementById('error-output');
        
        const code = codeInput.value.trim();
        if (!code) {
            this.showError('Veuillez entrer du code √† ex√©cuter');
            return;
        }
        
        runButton.disabled = true;
        runButton.innerHTML = '<span>‚è≥</span> Ex√©cution...';
        errorDiv.style.display = 'none';
        outputDiv.innerHTML = '<div class="loading">üîÑ Ex√©cution en cours...</div>';
        
        try {
            // V√©rifier que holbiesApp est disponible
            if (!window.holbiesApp || !window.holbiesApp.token) {
                throw new Error('Vous devez √™tre connect√© pour utiliser le tuteur');
            }
            
            const response = await fetch('/api/tutor/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.holbiesApp.token}`
                },
                body: JSON.stringify({ 
                    code: code, 
                    language: this.currentLanguage 
                })
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Session expir√©e. Veuillez vous reconnecter.');
                }
                const errorData = await response.json().catch(() => ({ detail: 'Erreur r√©seau' }));
                throw new Error(errorData.detail || 'Erreur lors de l\'ex√©cution');
            }
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            this.displayResults(result);
            
        } catch (err) {
            console.error('Erreur d√©taill√©e:', err);
            this.showError(err.message);
        } finally {
            runButton.disabled = false;
            runButton.innerHTML = '<span>‚ñ∂Ô∏è</span> Ex√©cuter';
        }
    }
    
    showError(message) {
        const errorDiv = document.getElementById('error-output');
        errorDiv.innerHTML = `‚ùå <strong>Erreur:</strong> ${message}`;
        errorDiv.style.display = 'block';
    }
    
    displayResults(result) {
        const outputDiv = document.getElementById('trace-output');
        
        let html = `<h3>üìä R√©sultats d'ex√©cution (${this.currentLanguage.toUpperCase()})</h3>`;
        
        if (result.output) {
            html += `
                <div class="trace-step">
                    <h4>üì§ Sortie du programme</h4>
                    <pre class="output-pre success-output">${result.output}</pre>
                </div>
            `;
        }
        
        if (result.error) {
            html += `
                <div class="trace-step">
                    <h4>‚ùå Erreur d'ex√©cution</h4>
                    <pre class="output-pre error-output">${result.error}</pre>
                </div>
            `;
        }
        
        if (result.trace && result.trace.length > 0) {
            html += `
                <div class="trace-step">
                    <h4>üîç Trace d'ex√©cution</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;
            result.trace.forEach((step, index) => {
                html += `
                    <div style="border: 1px solid #e2e8f0; margin: 0.5rem 0; padding: 0.5rem; border-radius: 4px;">
                        <strong>√âtape ${index + 1}:</strong>
                        <pre class="output-pre" style="margin: 0.25rem 0; font-size: 0.9rem;">${JSON.stringify(step, null, 2)}</pre>
                    </div>
                `;
            });
            html += `
                    </div>
                </div>
            `;
        }
        
        if (!result.output && !result.error && (!result.trace || result.trace.length === 0)) {
            html += '<div class="loading">ü§î Aucun r√©sultat disponible</div>';
        }
        
        outputDiv.innerHTML = html;
    }
    
    setLanguage(language) {
        this.currentLanguage = language;
        document.getElementById('language-select').value = language;
        this.updatePlaceholder();
    }
    
    setCode(code) {
        document.getElementById('code-input').value = code;
    }
}

// Exemples de code
function loadPythonExample() {
    const code = `# Exemple Python - Calculs et structures de donn√©es
x = 5
y = 10
z = x + y
print(f'La somme est: {z}')

# Boucle avec liste
numbers = [1, 2, 3, 4, 5]
total = 0
for num in numbers:
    total += num
    print(f'Ajout de {num}, total: {total}')

print(f'Somme totale: {total}')

# Fonction r√©cursive
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

result = fibonacci(6)
print(f'Fibonacci(6) = {result}')`;
    
    window.hlhTutor.setLanguage('python');
    window.hlhTutor.setCode(code);
}

function loadJavaScriptExample() {
    const code = `// Exemple JavaScript - Manipulation de tableaux
let x = 5;
let y = 10;
let z = x + y;
console.log(\`La somme est: \${z}\`);

// Boucle avec tableau
const numbers = [1, 2, 3, 4, 5];
let total = 0;
for(let i = 0; i < numbers.length; i++) {
    total += numbers[i];
    console.log(\`Ajout de \${numbers[i]}, total: \${total}\`);
}

console.log(\`Somme totale: \${total}\`);

// Fonction r√©cursive
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n-1) + fibonacci(n-2);
}

const result = fibonacci(6);
console.log(\`Fibonacci(6) = \${result}\`);`;
    
    window.hlhTutor.setLanguage('javascript');
    window.hlhTutor.setCode(code);
}

function loadCExample() {
    const code = `// Exemple C - Structures de contr√¥le et tableaux
#include <stdio.h>

int fibonacci(int n) {
    if (n <= 1) return n;
    return fibonacci(n-1) + fibonacci(n-2);
}

int main() {
    int x = 5;
    int y = 10;
    int z = x + y;
    printf("La somme est: %d\\n", z);
    
    // Tableau et boucle
    int numbers[] = {1, 2, 3, 4, 5};
    int total = 0;
    int size = sizeof(numbers) / sizeof(numbers[0]);
    
    for(int i = 0; i < size; i++) {
        total += numbers[i];
        printf("Ajout de %d, total: %d\\n", numbers[i], total);
    }
    
    printf("Somme totale: %d\\n", total);
    
    // Fonction r√©cursive
    int result = fibonacci(6);
    printf("Fibonacci(6) = %d\\n", result);
    
    return 0;
}`;
    
    window.hlhTutor.setLanguage('c');
    window.hlhTutor.setCode(code);
}

// Initialiser le tuteur
document.addEventListener('DOMContentLoaded', () => {
    window.hlhTutor = new HLHTutor();
});
</script>
{% endblock %}
